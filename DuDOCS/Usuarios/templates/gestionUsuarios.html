{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de usuarios</title>
    {% tailwind_css %}
  </head>
  <body>
    {% include 'header.html' %}
    <input type="text" id="busqueda" placeholder="Buscar..." class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
    <button class="btnAgregarUsuario bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Agregar Usuario
    </button>
    <div>
        <table class="table-auto">
            <thead>
                <tr>
                    <th class="px-4 py-2">Username</th>
                    <th class="px-4 py-2">Email</th>
                    <th class="px-4 py-2">Rol</th>
                    <th class="px-4 py-2">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-id="{{ user.id }}">
                    <td class="px-4 py-2">{{ user.username }}</td>
                    <td class="px-4 py-2">{{ user.email }}</td>
                    <td class="px-4 py-2">{{ user.userprofile.rol }}</td>
                    <td class="px-4 py-2">
                        <button class="btnEditarUsuario bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Editar
                        </button>
                        <button class="delete-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Eliminar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal para editar usuario -->
    <div id="modalEditarUsuario" style="display: none;">
        <form id="formEditarUsuario" method="POST">
            {% csrf_token %}
            <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
            <input type="text" id="username" name="username" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" name="email" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="rol" class="block text-gray-700 text-sm font-bold mb-2">Rol:</label>
            <select id="rol" name="rol"
                    class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="Administrador">Administrador</option>
                <option value="Docente">Docente</option>
                <option value="CoordinadorDocente">Coordinador Docente</option>
                <option value="Ayudante">Ayudante</option>
                <option value="Dara">Dara</option>
                <option value="PuntoEstudiantil">Punto Estudiantil</option>
            </select>

            <label for="first_name" class="block text-gray-700 text-sm font-bold mb-2">First Name:</label>
            <input type="text" id="first_name" name="first_name" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="last_name" class="block text-gray-700 text-sm font-bold mb-2">Last Name:</label>
            <input type="text" id="last_name" name="last_name" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="is_active" class="block text-gray-700 text-sm font-bold mb-2">Is Active:</label>
            <input type="checkbox" id="is_active" name="is_active">

            <label for="is_staff" class="block text-gray-700 text-sm font-bold mb-2">Is Staff:</label>
            <input type="checkbox" id="is_staff" name="is_staff">

            <label for="is_superuser" class="block text-gray-700 text-sm font-bold mb-2">Is Superuser:</label>
            <input type="checkbox" id="is_superuser" name="is_superuser">

            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Guardar cambios
            </button>
        </form>
    </div>

    <!-- Modal para agregar usuario -->
    <div id="modalAgregarUsuario" style="display: none;">
        <form id="formAgregarUsuario" method="POST">
            {% csrf_token %}
            <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
            <input type="text" id="username" name="username" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="password1" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
            <input type="password" id="password1" name="password1" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="password2" class="block text-gray-700 text-sm font-bold mb-2">Confirm Password:</label>
            <input type="password" id="password2" name="password2" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" name="email" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="rol" class="block text-gray-700 text-sm font-bold mb-2">Rol:</label>
            <select id="rol" name="rol"
                    class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="Administrador">Administrador</option>
                <option value="Docente">Docente</option>
                <option value="CoordinadorDocente">Coordinador Docente</option>
                <option value="Ayudante">Ayudante</option>
                <option value="Dara">Dara</option>
                <option value="PuntoEstudiantil">Punto Estudiantil</option>
            </select>

            <label for="first_name" class="block text-gray-700 text-sm font-bold mb-2">First Name:</label>
            <input type="text" id="first_name" name="first_name" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="last_name" class="block text-gray-700 text-sm font-bold mb-2">Last Name:</label>
            <input type="text" id="last_name" name="last_name" required
                   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">

            <label for="is_staff" class="block text-gray-700 text-sm font-bold mb-2">Is Staff:</label>
            <input type="checkbox" id="is_staff" name="is_staff">

            <label for="is_superuser" class="block text-gray-700 text-sm font-bold mb-2">Is Superuser:</label>
            <input type="checkbox" id="is_superuser" name="is_superuser">

            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Agregar usuario
            </button>
        </form>
    </div>

<!-- Modal para editar usuario -->
<div id="modalEditarUsuario" style="display: none;">
  <form id="formEditarUsuario">
    {% csrf_token %}
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" required>

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>

      <label for="rol">Rol:</label>
      <select id="rol" name="rol">
        <!-- <option value="" disabled selected>Seleccionar Rol</option> -->
        <option value="Administrador">Administrador</option>
        <option value="Docente">Docente</option>
        <option value="CoordinadorDocente">Coordinador Docente</option>
        <option value="Ayudante">Ayudante</option>
        <option value="Dara">Dara</option>
        <option value="PuntoEstudiantil">Punto Estudiantil</option>
      </select>

      <label for="first_name">First Name:</label>
      <input type="text" id="first_name" name="first_name" required>

      <label for="last_name">Last Name:</label>
      <input type="text" id="last_name" name="last_name" required>

      <label for="is_active">Is Active:</label>
      <input type="checkbox" id="is_active" name="is_active">

      <label for="is_staff">Is Staff:</label>
      <input type="checkbox" id="is_staff" name="is_staff">

      <label for="is_superuser">Is Superuser:</label>
      <input type="checkbox" id="is_superuser" name="is_superuser">

      <button type="submit">Guardar cambios</button>
  </form>
</div>

<!-- Modal para agregar usuario -->
<div id="modalAgregarUsuario" style="display: none;">
  <form id="formAgregarUsuario">
    {% csrf_token %}
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" required>

      <label for="password1">Password:</label>
      <input type="password" id="password1" name="password1" required>

      <label for="password2">Confirm Password:</label>
      <input type="password" id="password2" name="password2" required>

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>

      <select id="rol" name="rol">
        <!-- <option value="" disabled selected>Seleccionar Rol</option> -->
        <option value="Administrador">Administrador</option>
        <option value="Docente">Docente</option>
        <option value="CoordinadorDocente">Coordinador Docente</option>
        <option value="Ayudante">Ayudante</option>
        <option value="Dara">Dara</option>
        <option value="PuntoEstudiantil">Punto Estudiantil</option>
      </select>

      <label for="first_name">First Name:</label>
      <input type="text" id="first_name" name="first_name" required>

      <label for="last_name">Last Name:</label>
      <input type="text" id="last_name" name="last_name" required>

      <!-- <label for="is_active">Is Active:</label>
      <input type="checkbox" id="is_active" name="is_active"> -->

      <label for="is_staff">Is Staff:</label>
      <input type="checkbox" id="is_staff" name="is_staff">

      <label for="is_superuser">Is Superuser:</label>
      <input type="checkbox" id="is_superuser" name="is_superuser">

      <button type="submit">Agregar usuario</button>
  </form>
</div>


<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Script para abrir el modal de creaci√≥n de usuario -->
<script>
    $(document).ready(function () {
        $(".btnAgregarUsuario").click(function () {
            $("#modalAgregarUsuario").show();
        });

        $("#.btnCerrarAgregarUsuario").click(function () {
            $("#modalAgregarUsuario").hide();
            $("#formAgregarUsuario")[0].reset();
        });
    });
</script>

    <!-- Script para abrir el modal de edici√≥n de usuario -->
    <script>
      $(document).ready(function () {
          $(".btnEditarUsuario").click(function () {
              var userRow = $(this).parents("tr");
              var userId = userRow.data("id");

              // Obtenemos los datos del usuario de la fila de la tabla
              var username = userRow.find("td:nth-child(1)").text();
              var email = userRow.find("td:nth-child(2)").text();
              var rol = userRow.find("td:nth-child(3)").text();
  
              // Asignamos los datos al formulario
              $("#username").val(username);
              $("#email").val(email);
              $("#rol").val(rol);

              // Para el resto de los campos, si no est√°n en la tabla, los dejamos en blanco
              $("#first_name").val("");
              $("#last_name").val("");
              $("#is_active").prop("checked", false);
              $("#is_staff").prop("checked", false);
              $("#is_superuser").prop("checked", false);

              $("#formEditarUsuario").attr("data-user-id", userId);

              $("#modalEditarUsuario").show();
          });

          $("#btnCerrarEditarUsuario").click(function () {
              $("#modalEditarUsuario").hide();
              $("#formEditarUsuario")[0].reset();
          });
      });
  </script>


<!-- Script para enviar el formulario de creaci√≥n de usuario -->
<script>
    $(document).ready(function () {
        $("#formAgregarUsuario").submit(function (e) {
            e.preventDefault();
            
            // Realiza una petici√≥n AJAX para enviar los datos del formulario de creaci√≥n
            $.ajax({
                url: "{% url 'crear_usuario' %}", // Reemplaza con la URL correcta
                type: "POST",
                data: $(this).serialize(),
                success: function (data) {
                    alert("Usuario creado exitosamente")
                    $("#modalAgregarUsuario").hide();
                    $("#formAgregarUsuario")[0].reset();
                },
                error: function (error) {
                    // Maneja errores y muestra mensajes de error si es necesario
                    alert("Error al crear usuario ", error)
                    console.log(error);
                }
            });
        });
    });
</script>

<!-- Script para enviar el formulario de edici√≥n de usuario -->
<!-- <script>
  $(document).ready(function () {
      $("#formEditarUsuario").submit(function (e) {
          e.preventDefault();
          var userId = $(this).attr("data-user-id");
          
          // Realiza una petici√≥n AJAX para enviar los datos del formulario de edici√≥n
          $.ajax({
              // url: "{% url 'editar_usuario' user.id %}",
              url: "/editar_usuario/" + userId + "/",
              type: "POST",
              data: $(this).serialize(),
              success: function (data) {

                  // Cierra el modal de edici√≥n, limpia los campos y actualiza la interfaz
                  $("#modalEditarUsuario").hide();
                  $("#formEditarUsuario")[0].reset();
                 location.reload(); // Recarga la p√°gina para ver los cambios
              },
              error: function (error) {
                  console.log(error);
              }
          });
      });
  });
</script> -->

<script>
  $(document).ready(function () {
      $(".btnEditarUsuario").click(function () {
          var userRow = $(this).parents("tr");
          var userId = userRow.data("id");

          // Realiza una petici√≥n AJAX para obtener los datos del usuario
          $.ajax({
              url: "/obtener_usuario/" + userId + "/",
              type: "GET",
              success: function (data) {
                  // Asignamos los datos al formulario
                  $("#username").val(data.username);
                  $("#email").val(data.email);
                  $("#rol").val(data.rol);
                  $("#first_name").val(data.first_name);
                  $("#last_name").val(data.last_name);
                  $("#is_active").prop("checked", data.is_active);
                  $("#is_staff").prop("checked", data.is_staff);
                  $("#is_superuser").prop("checked", data.is_superuser);

                  $("#formEditarUsuario").attr("data-user-id", userId);

                  $("#modalEditarUsuario").show();
              },
              error: function (error) {
                  console.log(error);
              }
          });
      });

      $("#btnCerrarEditarUsuario").click(function () {
          $("#modalEditarUsuario").hide();
          $("#formEditarUsuario")[0].reset();
      });
  });
</script>

<script>
  $(document).ready(function () {
      $("#formEditarUsuario").submit(function (e) {
          e.preventDefault();
          var userId = $(this).attr("data-user-id");
          
          // Realiza una petici√≥n AJAX para enviar los datos del formulario de edici√≥n
          $.ajax({
              url: "/editar_usuario/" + userId + "/",
              type: "POST",
              data: $(this).serialize(),
              success: function (data) {
                  if (data.error) {
                      alert(data.error);
                  } else {
                      // Cierra el modal de edici√≥n, limpia los campos y actualiza la interfaz
                      alert('Usuario editado con √©xito');
                      $("#modalEditarUsuario").hide();
                      $("#formEditarUsuario")[0].reset();
                     location.reload(); // Recarga la p√°gina para ver los cambios
                  }
              },
              error: function (error) {
                  console.log(error);
              }
          });
      });
  });
</script>



<!-- eliminar_usuario -->
<script>
  $(document).ready(function(){
  $(".delete-button").on("click", function(){
      var row = $(this).closest("tr");
      var id = row.data("id");  // Obtener el ID del documento

      // Confirmar la eliminaci√≥n
      if (!confirm("¬øEst√°s seguro de que quieres eliminar este usuario?")) {
          return;
      }

      $.ajax({
          url: "/eliminar_usuario/" + id + "/",  // Generar la URL din√°micamente
          type: 'POST',
          data: {'documento_id': id},
          success: function (data) {
              alert('usuario eliminado con √©xito');
              
              // Enviar mensaje a la ventana principal.
              window.parent.postMessage('reloadIframes', '*');    
          },
          error: function(jqXHR, textStatus, errorThrown) {
              alert('Error al eliminar usuario: ' + errorThrown);
          }
      });
  });
});

</script>

<!-- filtro -->
<script>
    $(document).ready(function(){
        $("#busqueda").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("table tbody tr").filter(function() {
                var username = $(this).find("td:nth-child(1)").text().toLowerCase();
                var email = $(this).find("td:nth-child(2)").text().toLowerCase();
                var rol = $(this).find("td:nth-child(3)").text().toLowerCase();
                $(this).toggle(username.indexOf(value) > -1 || email.indexOf(value) > -1 || rol.indexOf(value) > -1)
            });
        });
    });
</script>


 </body>
</html>
